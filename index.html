<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle de Materiais</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.0/chart.min.js"></script>
    <style>
        body {
            background: linear-gradient(rgba(0, 0, 0, 0.6), rgba(0, 0, 0, 0.6)),
                        url('https://raw.githubusercontent.com/cosmonitoramento/imagem_usina/refs/heads/main/djiusina.jpg') no-repeat center center fixed;
            background-size: cover;
            color: #fff;
            min-height: 100vh;
        }

        .entrada { color: #22c55e; font-weight: bold; }
        .saida { color: #ef4444; font-weight: bold; }
        
        .historico-item {
            padding: 10px;
            margin-bottom: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: linear-gradient(145deg, #ffffff, #f3f4f6);
            transition: all 0.3s ease;
        }

        .historico-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .material-item {
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #e5e7eb;
            border-radius: 4px;
            background: linear-gradient(145deg, #ffffff, #f8fafc);
            transition: all 0.3s ease;
        }

        .material-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .tab-pane { padding: 20px 0; }
        
        .card {
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            background: rgba(255, 255, 255, 0.95);
            transition: all 0.3s ease;
        }

        .card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 8px rgba(0,0,0,0.15);
        }

        .card-header {
            background: linear-gradient(45deg, #3b82f6, #2563eb);
            color: white;
        }

        .card-header.bg-success {
            background: linear-gradient(45deg, #22c55e, #16a34a);
        }

        .card-header.bg-info {
            background: linear-gradient(45deg, #0ea5e9, #0284c7);
        }

        .btn { transition: all 0.3s ease; }
        .btn:hover { transform: translateY(-1px); }

        .table { background: rgba(255, 255, 255, 0.98); }
        .table-striped > tbody > tr:nth-of-type(odd) {
            background: rgba(249, 250, 251, 0.95);
        }

        .btn-outline-primary {
            color: #3b82f6;
            border-color: #3b82f6;
            background-color: white;
        }

        .btn-outline-primary:hover {
            color: white;
            background-color: #3b82f6;
        }

        .btn-outline-primary.active {
            color: white;
            background-color: #3b82f6;
        }

        .input-group {
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .input-group .form-control:focus {
            box-shadow: none;
            border-color: #3b82f6;
        }

        .btn-group {
            width: 100%;
        }

        .btn-group .btn {
            flex: 1;
        }

        /* Estilos para o Dashboard */
        .dashboard-card {
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .dashboard-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0,0,0,0.1);
        }

        .stat-card {
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 5px;
            line-height: 1;
        }

        .stat-label {
            color: #666;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* Estilos para os gráficos */
        #graficoMovimentacoes, #graficoArmarios {
            background: white;
            border-radius: 8px;
            padding: 10px;
        }
    </style>
</head>
<body class="bg-light">
    <div class="container my-4">
        <!-- Abas -->
        <ul class="nav nav-tabs mb-4" id="myTab" role="tablist">
            <li class="nav-item">
                <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#cadastro" type="button">
                    Cadastro
                </button>
            </li>
            <li class="nav-item">
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#movimentacao" type="button">
                    Movimentação
                </button>
            </li>
            <li class="nav-item">
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#dashboard" type="button">
                    Dashboard
                </button>
            </li>
        </ul>

        <!-- Botão Exportar -->
        <div class="mb-3">
            <button onclick="exportarHistorico()" class="btn btn-success">
                Exportar Histórico
            </button>
        </div>

        <div class="tab-content">
            <!-- Aba de Cadastro -->
            <div class="tab-pane fade show active" id="cadastro">
                <div class="row">
                    <!-- Formulário de Cadastro -->
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header bg-primary text-white">
                                <h5 class="mb-0">Cadastro de Material</h5>
                            </div>
                            <div class="card-body">
                                <form id="formCadastro" onsubmit="cadastrarMaterial(event)">
                                    <div class="mb-3">
                                        <label class="form-label">Código</label>
                                        <input type="text" id="codigo" class="form-control" required>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Descrição</label>
                                        <input type="text" id="descricao" class="form-control" required>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Quantidade</label>
                                        <input type="number" id="quantidade" class="form-control" min="0" required>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Estoque</label>
                                        <input type="text" id="armario" class="form-control" required>
                                    </div>
                                    <button type="submit" class="btn btn-primary">Cadastrar</button>
                                </form>
                            </div>
                        </div>
                    </div>
                    <!-- Lista de Materiais com Pesquisa -->
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header bg-success text-white">
                                <h5 class="mb-0">Materiais Cadastrados</h5>
                            </div>
                            <div class="card-body">
                                <!-- Campo de Pesquisa -->
                                <div class="mb-3">
                                    <div class="input-group">
                                        <input type="text" id="pesquisaMaterial" class="form-control" 
                                               placeholder="Pesquisar por descrição ou armário">
                                        <button class="btn btn-secondary" onclick="pesquisarMaterial()">
                                            Pesquisar
                                        </button>
                                    </div>
                                    <div class="mt-2">
                                        <div class="btn-group" role="group">
                                            <button type="button" class="btn btn-outline-primary active" onclick="filtrarPorTipo('todos')">Todos</button>
                                            <button type="button" class="btn btn-outline-primary" onclick="filtrarPorTipo('material')">Material</button>
                                            <button type="button" class="btn btn-outline-primary" onclick="filtrarPorTipo('armario')">Armário</button>
                                        </div>
                                    </div>
                                </div>
                                <div id="listaMateriais"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Aba de Movimentação -->
            <div class="tab-pane fade" id="movimentacao">
                <div class="row">
                    <!-- Formulário de Movimentação -->
                    <div class="col-md-8">
                        <div class="card mb-4">
                            <div class="card-header bg-primary text-white">
                                <h5 class="mb-0">Movimentação de Material</h5>
                            </div>
                            <div class="card-body">
                                <form id="formMovimentacao" onsubmit="registrarMovimentacao(event)">
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Material</label>
                                            <select id="materialSelect" class="form-select" required>
                                                <option value="">Selecione um material</option>
                                            </select>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Tipo de Movimentação</label>
                                            <select id="tipoMovimentacao" class="form-select" required>
                                                <option value="entrada">Entrada</option>
                                                <option value="saida">Saída</option>
                                            </select>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Quantidade</label>
                                            <input type="number" id="quantidadeMov" class="form-control" min="1" required>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Responsável</label>
                                            <input type="text" id="responsavel" class="form-control" required>
                                            
                                            <label class="form-label mt-2">Movimento</label>
                                            <select id="Movimento" class="form-select" required>
                                                <option value="Devolução">Devolução</option>
                                                <option value="Descarte">Descarte</option>
                                                <option value="Manutenção">Manutenção</option>
                                            </select>
                                        </div>
                                        <div class="col-12">
                                            <button type="submit" class="btn btn-primary">Registrar Movimentação</button>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>
                        <!-- Histórico -->
                        <div class="card">
                            <div class="card-header bg-info text-white">
                                <h5 class="mb-0">Histórico de Movimentações</h5>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <input type="text" id="pesquisaHistorico" class="form-control" 
                                           placeholder="Pesquisar por material ou responsável">
                                    <button class="btn btn-secondary mt-2" onclick="pesquisarHistorico()">
                                        Pesquisar
                                    </button>
                                </div>
                                <div class="mb-3">
                                    <button class="btn btn-danger" onclick="excluirUltimaLinha()">
                                        Excluir Última Linha
                                    </button>
                                </div>
                                <div class="table-responsive">
                                    <table class="table table-striped">
                                        <thead>
                                            <tr>
                                                <th>Data/Hora</th>
                                                <th>Material</th>
                                                <th>Tipo</th>
                                                <th>Quantidade</th>
                                                <th>Responsável</th>
                                                <th>Movimento</th>
                                                <th>Saldo</th>
                                            </tr>
                                        </thead>
                                        <tbody id="historicoMovimentacoes"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Painel de Estoque -->
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-header bg-success text-white">
                                <h5 class="mb-0">Estoque Atual</h5>
                            </div>
                            <div class="card-body">
                                <div id="estoqueAtual"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Aba do Dashboard -->
            <div class="tab-pane fade" id="dashboard">
                <div class="row">
                    <!-- Gráfico de Movimentações por Mês -->
                    <div class="col-md-6">
                        <div class="card dashboard-card">
                            <div class="card-header bg-primary text-white">
                                <h5 class="mb-0">Movimentações por Mês</h5>
                            </div>
                            <div class="card-body">
                                <canvas id="graficoMovimentacoes" height="300"></canvas>
                            </div>
                        </div>
                    </div>
                    <!-- Resumo de Movimentações -->
                    <div class="col-md-6">
                        <div class="card dashboard-card">
                            <div class="card-header bg-success text-white">
                                <h5 class="mb-0">Resumo do Mês Atual</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <div class="stat-card">
                                            <div class="stat-number text-success" id="totalEntradas">0</div>
                                            <div class="stat-label">Entradas</div>
                                        </div>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <div class="stat-card">
                                            <div class="stat-number text-danger" id="totalSaidas">0</div>
                                            <div class="stat-label">Saídas</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Top 5 Materiais Mais Movimentados -->
                        <div class="card dashboard-card mt-4">
                            <div class="card-header bg-info text-white">
                                <h5 class="mb-0">Top 5 Materiais Mais Movimentados</h5>
                            </div>
                            <div class="card-body">
                                <div id="topMateriais"></div>
                            </div>
                        </div>
                        <!-- Gráfico de Pizza - Distribuição por Armário -->
                        <div class="card dashboard-card mt-4">
                            <div class="card-header bg-warning text-white">
                                <h5 class="mb-0">Distribuição por Armário</h5>
                            </div>
                            <div class="card-body">
                                <canvas id="graficoArmarios" height="200"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/js/bootstrap.bundle.min.js"></script>
    <script>
        // URL da Web App do Google Apps Script
        const API_URL = 'https://script.google.com/macros/s/AKfycbyilwx1Uo41sRCJPVYHrBmiVZ6i0G1swBC2vRUjRrtBkBh28toUFc3eoOeMdvkTViuRHQ/exec';

        // Variáveis globais para pesquisa e gráficos
        let tipoFiltragem = 'todos';
        let materiaisCache = [];
        let graficoMovimentacoes = null;
        let graficoArmarios = null;

        // Função para fazer chamadas à API
        async function callAPI(method, action, data = null) {
            try {
                const url = new URL(API_URL);
                
                if (method === 'GET') {
                    if (data) {
                        Object.keys(data).forEach(key => 
                            url.searchParams.append(key, data[key]));
                    }
                    const response = await fetch(url);
                    return await response.json();
                } else {
                    data = data || {};
                    data.action = action;
                    
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: new URLSearchParams(data)
                    });
                    return await response.json();
                }
            } catch (error) {
                console.error('Erro na API:', error);
                throw error;
            }
        }

        // Função para carregar dados
        async function carregarDados() {
            try {
                const response = await callAPI('GET', null);
                console.log('Dados carregados:', response);
                
                atualizarListaMateriais(response.materiais);
                atualizarSelectMateriais(response.materiais);
                atualizarHistorico(response.movimentacoes);
                atualizarEstoque(response.materiais);
            } catch (error) {
                console.error('Erro ao carregar dados:', error);
                alert('Erro ao carregar dados. Verifique o console para mais detalhes.');
            }
        }

        // Função para cadastrar material
        async function cadastrarMaterial(event) {
            event.preventDefault();
            
            const codigo = document.getElementById('codigo').value.trim();
            const descricao = document.getElementById('descricao').value.trim();
            const quantidade = document.getElementById('quantidade').value;
            const armario = document.getElementById('armario').value.trim();

            if (!codigo || !descricao || !armario) {
                alert('Preencha todos os campos obrigatórios!');
                return;
            }

            try {
                console.log('Cadastrando material:', { codigo, descricao, quantidade, armario });

                const response = await callAPI('POST', 'cadastrarMaterial', {
                    codigo,
                    descricao,
                    quantidade,
                    armario
                });

                if (response.status === 'success') {
                    alert('Material cadastrado com sucesso!');
                    document.getElementById('formCadastro').reset();
                    await carregarDados();
                } else {
                    throw new Error(response.message);
                }
            } catch (error) {
                alert('Erro ao cadastrar material: ' + error.message);
            }
        }

        // Função para registrar movimentação
        async function registrarMovimentacao(event) {
            event.preventDefault();

            const codigo = document.getElementById('materialSelect').value;
            const tipo = document.getElementById('tipoMovimentacao').value;
            const quantidade = document.getElementById('quantidadeMov').value;
            const responsavel = document.getElementById('responsavel').value.trim();
            const movimento = document.getElementById('Movimento').value;

            if (!codigo || !quantidade || !responsavel || !movimento) {
                alert('Preencha todos os campos obrigatórios!');
                return;
            }

            try {
                console.log('Enviando movimentação:', {
                    codigo,
                    tipo,
                    quantidade,
                    responsavel,
                    movimento
                });

                const response = await callAPI('POST', 'registrarMovimentacao', {
                    codigo,
                    tipo,
                    quantidade,
                    responsavel,
                    movimento
                });

                if (response.status === 'success') {
                    alert(response.message);
                    document.getElementById('formMovimentacao').reset();
                    await carregarDados();
                    await atualizarDashboard(); // Atualiza o dashboard após movimentação
                } else {
                    throw new Error(response.message);
                }
            } catch (error) {
                console.error('Erro detalhado:', error);
                alert('Erro ao registrar movimentação: ' + error.message);
            }
        }

        // Função para excluir última linha
        async function excluirUltimaLinha() {
            const credencial = prompt('Digite sua credencial para confirmar a exclusão:');
            if (credencial !== '123456') {
                alert('Credencial incorreta. A exclusão foi cancelada.');
                return;
            }

            try {
                const response = await callAPI('POST', 'excluirUltimaLinha');
                if (response.status === 'success') {
                    alert('Última movimentação excluída com sucesso!');
                    await carregarDados();
                    await atualizarDashboard(); // Atualiza o dashboard após exclusão
                } else {
                    throw new Error(response.message);
                }
            } catch (error) {
                alert('Erro ao excluir movimentação: ' + error.message);
            }
        }

        // Função para exportar histórico
        async function exportarHistorico() {
            try {
                const response = await callAPI('GET', null);
                const movimentacoes = response.movimentacoes;

                const dadosExportar = movimentacoes.map(mov => ({
                    'Data/Hora': mov.data,
                    'Material': mov.descricao,
                    'Tipo': mov.tipo.toUpperCase(),
                    'Quantidade': mov.quantidade,
                    'Responsável': mov.responsavel,
                    'Movimento': mov.movimento,
                    'Saldo': mov.saldo,
                    'Armário': mov.armario || 'Não especificado'
                }));

                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.json_to_sheet(dadosExportar);

                const wscols = [
                    {wch: 20}, // Data/Hora
                    {wch: 30}, // Material
                    {wch: 10}, // Tipo
                    {wch: 12}, // Quantidade
                    {wch: 20}, // Responsável
                    {wch: 15}, // Movimento
                    {wch: 10}, // Saldo
                    {wch: 15}  // Armário
                ];
                ws['!cols'] = wscols;

                XLSX.utils.book_append_sheet(wb, ws, "Histórico de Movimentações");
                XLSX.writeFile(wb, "historico_movimentacoes.xlsx");
            } catch (error) {
                alert('Erro ao exportar histórico: ' + error.message);
            }
        }

        // Função para pesquisar material
        function pesquisarMaterial() {
            const pesquisa = document.getElementById('pesquisaMaterial').value.toLowerCase();
            const materiaisItems = document.querySelectorAll('.material-item');
            
            materiaisItems.forEach(item => {
                const texto = item.textContent.toLowerCase();
                const material = materiaisCache.find(m => 
                    m.codigo === item.getAttribute('data-codigo')
                );
                
                let mostrar = false;
                
                switch(tipoFiltragem) {
                    case 'material':
                        mostrar = material.descricao.toLowerCase().includes(pesquisa);
                        break;
                    case 'armario':
                        mostrar = material.armario.toLowerCase().includes(pesquisa);
                        break;
                    default: // 'todos'
                        mostrar = texto.includes(pesquisa);
                        break;
                }
                
                item.style.display = mostrar ? '' : 'none';
            });
        }

        // Função para filtrar por tipo
        function filtrarPorTipo(tipo) {
            tipoFiltragem = tipo;
            const buttons = document.querySelectorAll('.btn-outline-primary');
            buttons.forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            pesquisarMaterial();
        }

        // Função para pesquisar no histórico
        function pesquisarHistorico() {
            const pesquisa = document.getElementById('pesquisaHistorico').value.toLowerCase();
            const rows = document.querySelectorAll('#historicoMovimentacoes tr');
            
            rows.forEach(row => {
                const texto = row.textContent.toLowerCase();
                row.style.display = texto.includes(pesquisa) ? '' : 'none';
            });
        }

        // Função para atualizar lista de materiais
        function atualizarListaMateriais(materiais) {
            const lista = document.getElementById('listaMateriais');
            materiaisCache = materiais;
            
            if (!materiais || materiais.length === 0) {
                lista.innerHTML = '<div class="alert alert-info">Nenhum material cadastrado.</div>';
                return;
            }

            lista.innerHTML = materiais.map(material => `
                <div class="material-item" data-codigo="${material.codigo}">
                    <strong>${material.descricao}</strong><br>
                    Quantidade em estoque: <strong>${material.quantidade}</strong><br>
                    <small class="text-muted">Código: ${material.codigo}</small><br>
                    <small class="text-muted">Armário: ${material.armario || 'Nãoespecificado'}</small>
                </div>
            `).join('');
        }

        // Função para atualizar select de materiais
        function atualizarSelectMateriais(materiais) {
            const select = document.getElementById('materialSelect');
            if (!select) return;

            console.log('Atualizando select com materiais:', materiais);

            select.innerHTML = '<option value="">Selecione um material</option>' + 
                materiais.map(material => `
                    <option value="${material.codigo}">
                        ${material.descricao} (Estoque: ${material.quantidade}, Armário: ${material.armario})
                    </option>
                `).join('');
        }

        // Função para atualizar histórico
        function atualizarHistorico(movimentacoes) {
            const tbody = document.getElementById('historicoMovimentacoes');
            
            if (!movimentacoes || movimentacoes.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center">Nenhuma movimentação registrada.</td></tr>';
                return;
            }

            tbody.innerHTML = movimentacoes.map(mov => `
                <tr>
                    <td>${mov.data}</td>
                    <td>${mov.descricao}</td>
                    <td class="${mov.tipo}">${mov.tipo.toUpperCase()}</td>
                    <td>${mov.quantidade}</td>
                    <td>${mov.responsavel}</td>
                    <td>${mov.movimento}</td>
                    <td><strong>${mov.saldo}</strong></td>
                </tr>
            `).join('');
        }

        // Função para atualizar estoque
        function atualizarEstoque(materiais) {
            const estoque = document.getElementById('estoqueAtual');
            
            if (!materiais || materiais.length === 0) {
                estoque.innerHTML = '<div class="alert alert-info">Nenhum material em estoque.</div>';
                return;
            }

            estoque.innerHTML = materiais.map(material => `
                <div class="historico-item">
                    <strong>${material.descricao}</strong><br>
                    Quantidade em estoque: <strong>${material.quantidade}</strong><br>
                    <small class="text-muted">Código: ${material.codigo}</small><br>
                    <small class="text-muted">Armário: ${material.armario || 'Não especificado'}</small>
                </div>
            `).join('');
        }

        // Funções do Dashboard
        function processarDadosPorMes(movimentacoes) {
            const dados = {};
            
            movimentacoes.forEach(mov => {
                const data = new Date(mov.data);
                const mesAno = `${data.getMonth() + 1}/${data.getFullYear()}`;
                
                if (!dados[mesAno]) {
                    dados[mesAno] = { entradas: 0, saidas: 0 };
                }
                
                if (mov.tipo === 'entrada') {
                    dados[mesAno].entradas += mov.quantidade;
                } else {
                    dados[mesAno].saidas += mov.quantidade;
                }
            });
            
            return dados;
        }

        function criarGraficoMovimentacoes(dados) {
            const ctx = document.getElementById('graficoMovimentacoes').getContext('2d');
            
            if (graficoMovimentacoes) {
                graficoMovimentacoes.destroy();
            }
            
            const labels = Object.keys(dados).sort();
            const dataEntradas = labels.map(mes => dados[mes].entradas);
            const dataSaidas = labels.map(mes => dados[mes].saidas);
            
            graficoMovimentacoes = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Entradas',
                            data: dataEntradas,
                            backgroundColor: 'rgba(34, 197, 94, 0.5)',
                            borderColor: 'rgb(34, 197, 94)',
                            borderWidth: 1
                        },
                        {
                            label: 'Saídas',
                            data: dataSaidas,
                            backgroundColor: 'rgba(239, 68, 68, 0.5)',
                            borderColor: 'rgb(239, 68, 68)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function criarGraficoArmarios(materiais) {
            const ctx = document.getElementById('graficoArmarios').getContext('2d');
            
            if (graficoArmarios) {
                graficoArmarios.destroy();
            }

            const dadosArmarios = materiais.reduce((acc, material) => {
                const armario = material.armario || 'Não especificado';
                if (!acc[armario]) {
                    acc[armario] = 0;
                }
                acc[armario] += material.quantidade;
                return acc;
            }, {});

            const labels = Object.keys(dadosArmarios);
            const data = Object.values(dadosArmarios);
            const cores = labels.map((_, i) => 
                `hsl(${(i * 360) / labels.length}, 70%, 50%)`
            );

            graficoArmarios = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: cores,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'right'
                        }
                    }
                }
            });
        }

        async function atualizarDashboard() {
            try {
                const response = await callAPI('GET', null);
                const { movimentacoes, materiais } = response;

                // Gráfico de movimentações
                const dadosPorMes = processarDadosPorMes(movimentacoes);
                criarGraficoMovimentacoes(dadosPorMes);

                // Gráfico de armários
                criarGraficoArmarios(materiais);

                // Atualiza contadores do mês atual
                const dataAtual = new Date();
                const mesAtual = dataAtual.getMonth();
                const anoAtual = dataAtual.getFullYear();

                const movimentacoesMesAtual = movimentacoes.filter(mov => {
                    const data = new Date(mov.data);
                    return data.getMonth() === mesAtual && data.getFullYear() === anoAtual;
                });

                const totais = movimentacoesMesAtual.reduce((acc, mov) => {
                    if (mov.tipo === 'entrada') {
                        acc.entradas += mov.quantidade;
                    } else {
                        acc.saidas += mov.quantidade;
                    }
                    return acc;
                }, { entradas: 0, saidas: 0 });

                document.getElementById('totalEntradas').textContent = totais.entradas;
                document.getElementById('totalSaidas').textContent = totais.saidas;

                // Top materiais
                const materiaisCount = {};
                movimentacoes.forEach(mov => {
                    if (!materiaisCount[mov.descricao]) {
                        materiaisCount[mov.descricao] = 0;
                    }
                    materiaisCount[mov.descricao] += mov.quantidade;
                });

                const topMateriais = Object.entries(materiaisCount)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 5);

                const htmlTopMateriais = topMateriais.map((material, index) => `
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span>${index + 1}. ${material[0]}</span>
                        <span class="badge bg-primary">${material[1]} movimentações</span>
                    </div>
                `).join('');

                document.getElementById('topMateriais').innerHTML = htmlTopMateriais;

            } catch (error) {
                console.error('Erro ao atualizar dashboard:', error);
            }
        }

        // Eventos de carregamento e inicialização
        document.addEventListener('DOMContentLoaded', function() {
            carregarDados();
            
            // Adiciona evento de pesquisa ao pressionar Enter
            const campoPesquisa = document.getElementById('pesquisaMaterial');
            if (campoPesquisa) {
                campoPesquisa.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        pesquisarMaterial();
                    }
                });
            }

            // Atualiza dashboard ao carregar e quando trocar para a aba
            document.querySelectorAll('[data-bs-toggle="tab"]').forEach(tab => {
                tab.addEventListener('shown.bs.tab', function(e) {
                    if (e.target.getAttribute('data-bs-target') === '#dashboard') {
                        atualizarDashboard();
                    }
                });
            });
        });
    </script>
</body>
</html>
